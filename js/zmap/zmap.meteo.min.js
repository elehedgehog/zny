L.Util.GPS={PI:3.141592653589793,x_pi:3.141592653589793*3e3/180,delta:function(lat,lon){var a=6378245;var ee=.006693421622965943;var dLat=this.transformLat(lon-105,lat-35);var dLon=this.transformLon(lon-105,lat-35);var radLat=lat/180*this.PI;var magic=Math.sin(radLat);magic=1-ee*magic*magic;var sqrtMagic=Math.sqrt(magic);dLat=dLat*180/(a*(1-ee)/(magic*sqrtMagic)*this.PI);dLon=dLon*180/(a/sqrtMagic*Math.cos(radLat)*this.PI);return{lat:dLat,lon:dLon}},wgsToGcj:function(wgsLat,wgsLon){if(this.outOfChina(wgsLat,wgsLon))return{lat:wgsLat,lon:wgsLon};var d=this.delta(wgsLat,wgsLon);return{lat:wgsLat+d.lat,lon:wgsLon+d.lon}},gcjToWgs:function(gcjLat,gcjLon){if(this.outOfChina(gcjLat,gcjLon))return{lat:gcjLat,lon:gcjLon};var d=this.delta(gcjLat,gcjLon);return{lat:gcjLat-d.lat,lon:gcjLon-d.lon}},gcjToWgsExact:function(gcjLat,gcjLon){var initDelta=.01;var threshold=1e-9;var dLat=initDelta,dLon=initDelta;var mLat=gcjLat-dLat,mLon=gcjLon-dLon;var pLat=gcjLat+dLat,pLon=gcjLon+dLon;var wgsLat,wgsLon,i=0;while(1){wgsLat=(mLat+pLat)/2;wgsLon=(mLon+pLon)/2;var tmp=this.wgsToGcj(wgsLat,wgsLon);dLat=tmp.lat-gcjLat;dLon=tmp.lon-gcjLon;if(Math.abs(dLat)<threshold&&Math.abs(dLon)<threshold)break;if(dLat>0)pLat=wgsLat;else mLat=wgsLat;if(dLon>0)pLon=wgsLon;else mLon=wgsLon;if(++i>1e4)break}return{lat:wgsLat,lon:wgsLon}},gcjToBd:function(gcjLat,gcjLon){var x=gcjLon,y=gcjLat;var z=Math.sqrt(x*x+y*y)+2e-5*Math.sin(y*this.x_pi);var theta=Math.atan2(y,x)+3e-6*Math.cos(x*this.x_pi);bdLon=z*Math.cos(theta)+.0065;bdLat=z*Math.sin(theta)+.006;return{lat:bdLat,lon:bdLon}},bgToGcj:function(bdLat,bdLon){var x=bdLon-.0065,y=bdLat-.006;var z=Math.sqrt(x*x+y*y)-2e-5*Math.sin(y*this.x_pi);var theta=Math.atan2(y,x)-3e-6*Math.cos(x*this.x_pi);var gcjLon=z*Math.cos(theta);var gcjLat=z*Math.sin(theta);return{lat:gcjLat,lon:gcjLon}},distance:function(latA,logA,latB,logB){var earthR=6371e3;var x=Math.cos(latA*Math.PI/180)*Math.cos(latB*Math.PI/180)*Math.cos((logA-logB)*Math.PI/180);var y=Math.sin(latA*Math.PI/180)*Math.sin(latB*Math.PI/180);var s=x+y;if(s>1)s=1;if(s<-1)s=-1;var alpha=Math.acos(s);var distance=alpha*earthR;return distance},outOfChina:function(lat,lon){if(lon<72.004||lon>137.8347)return true;if(lat<.8293||lat>55.8271)return true;return false},transformLat:function(x,y){var ret=-100+2*x+3*y+.2*y*y+.1*x*y+.2*Math.sqrt(Math.abs(x));ret+=(20*Math.sin(6*x*this.PI)+20*Math.sin(2*x*this.PI))*2/3;ret+=(20*Math.sin(y*this.PI)+40*Math.sin(y/3*this.PI))*2/3;ret+=(160*Math.sin(y/12*this.PI)+320*Math.sin(y*this.PI/30))*2/3;return ret},transformLon:function(x,y){var ret=300+x+2*y+.1*x*x+.1*x*y+.1*Math.sqrt(Math.abs(x));ret+=(20*Math.sin(6*x*this.PI)+20*Math.sin(2*x*this.PI))*2/3;ret+=(20*Math.sin(x*this.PI)+40*Math.sin(x/3*this.PI))*2/3;ret+=(150*Math.sin(x/12*this.PI)+300*Math.sin(x/30*this.PI))*2/3;return ret}};L.Util.angle2Rad=function(angle){return angle*Math.PI/180};L.Util.rad2Angle=function(rad){return rad*180/Math.PI};L.Util.lineAngle=function(latlng1,latlng2){var dltLat=latlng2.lat-latlng1.lat;var dltLng=latlng2.lng-latlng1.lng;var theta=L.Util.rad2Angle(Math.atan(dltLat/dltLng));if(theta>0){if(latlng2.lng>latlng1.lng){theta=theta}else{theta=theta+180}}else if(theta<0){if(latlng2.lng>latlng1.lng){theta=360+theta}else{theta=180+theta}}else{if(latlng2.lng>latlng1.lng){theta=0}else{theta=180}}return 90-theta};L.Util.linePoint=function(latlng1,latlng2,posRatio){var dltLat=latlng2.lat-latlng1.lat;var dltLng=latlng2.lng-latlng1.lng;var lat=latlng1.lat+dltLat*posRatio;var lng=latlng1.lng+dltLng*posRatio;return L.latLng(lat,lng)};L.Util.lineFromPoint=function(p1,p2){var tmp={};tmp.a=p2.y-p1.y;tmp.b=p1.x-p2.x;tmp.c=p2.x*p1.y-p1.x*p2.y;return tmp};L.Util.verticalLine=function(a,b,m){var l={};if(a.y==b.y){l.a=-1;l.b=0;l.c=m.x}else if(a.x==b.x){l.a=0;l.b=-1;l.c=m.y}else{var k=(a.x-b.x)/(b.y-a.y);l.a=k;l.b=-1;l.c=m.y-k*m.x}return l};L.Util.collinearPoint=function(a,b,disA){var line=L.Util.lineFromPoint(a,b);var vecAB={x:b.x-a.x,y:b.y-a.y};var dis=Math.sqrt(vecAB.x*vecAB.x+vecAB.y*vecAB.y);var p={x:(line.b*vecAB.x*a.x+line.b*vecAB.y*a.y+line.b*dis*disA+line.c*vecAB.y)/(vecAB.x*line.b-vecAB.y*line.a),y:-(vecAB.x*line.c+vecAB.x*a.x*line.a+vecAB.y*a.y*line.a+dis*disA*line.a)/(vecAB.x*line.b-vecAB.y*line.a)};return L.point(p.x,p.y)};L.Util.verticalPoints=function(a,b,m,disM){var line=L.Util.lineFromPoint(a,b);var vecAB={x:b.x-a.x,y:b.y-a.y};var dis=Math.sqrt(vecAB.x*vecAB.x+vecAB.y*vecAB.y);var ps=[];var vline=L.Util.verticalLine(a,b,m);ps[0]=L.point(-(vline.b*vecAB.x*m.y-vline.b*vecAB.y*m.x+vline.b*dis*disM+vline.c*vecAB.x)/(vecAB.x*vline.a+vecAB.y*vline.b),(vecAB.x*m.y*vline.a-vecAB.y*vline.c-vecAB.y*m.x*vline.a+dis*disM*vline.a)/(vecAB.x*vline.a+vecAB.y*vline.b));ps[1]=L.point(-(vline.b*vecAB.x*m.y-vline.b*vecAB.y*m.x+vline.b*dis*disM*-1+vline.c*vecAB.x)/(vecAB.x*vline.a+vecAB.y*vline.b),(vecAB.x*m.y*vline.a-vecAB.y*vline.c-vecAB.y*m.x*vline.a+dis*disM*-1*vline.a)/(vecAB.x*vline.a+vecAB.y*vline.b));return ps};L.Util.roundPoint=function(p){p.x=Math.round(p.x);p.y=Math.round(p.y);return p};L.AngleMarker=L.Marker.extend({_setPos:function(pos){L.DomUtil.setPosition(this._icon,pos);if(this._shadow){L.DomUtil.setPosition(this._shadow,pos)}if(this.options.iconAngle){this._icon.style.WebkitTransform=this._icon.style.WebkitTransform+" rotate("+this.options.iconAngle+"deg)";this._icon.style.MozTransform="rotate("+this.options.iconAngle+"deg)";this._icon.style.MsTransform="rotate("+this.options.iconAngle+"deg)";this._icon.style.OTransform="rotate("+this.options.iconAngle+"deg)"}this._icon.style.zIndex=pos.y;this._zIndex=pos.y+this.options.zIndexOffset;this._resetZIndex()}});L.angleMarker=function(latlng,options){return new L.AngleMarker(latlng,options)};L.arrowMarker=function(latlng,angle){var icon={iconUrl:"/js/tool/zmap/images/marker-arrow.png",iconSize:[20,28],iconAnchor:[10,14]};return L.angleMarker(latlng,{icon:new L.Icon(icon),iconAngle:angle})};L.Markerline=L.Polyline.extend({options:{smoothFactor:1,noClip:false,markerIcon:L.icon({iconUrl:"/js/tool/zmap/images/marker-arrow.png",iconSize:[20,28],iconAnchor:[10,14]}),markerPos:.5},initialize:function(latlngs,options){L.Path.prototype.initialize.call(this,options);this._latlngs=this._convertLatLngs(latlngs);this.icons=[];var size=this._latlngs.length;for(var i=0;i<size-1;i++){var latlng1=this._latlngs[i];var latlng2=this._latlngs[i+1];var latlng=L.Util.linePoint(latlng1,latlng2,this.options.markerPos);var angle=L.Util.lineAngle(latlng1,latlng2);var arrow=L.angleMarker(latlng,{icon:this.options.markerIcon,iconAngle:angle});this.icons.push(arrow)}},onAdd:function(map){this._map=map;if(!this._container){this._initElements();this._initEvents()}this.projectLatlngs();this._updatePath();if(this._container){this._map._pathRoot.appendChild(this._container);for(var i=0;i<this.icons.length;i++)this._map.addLayer(this.icons[i])}this.fire("add");map.on({viewreset:this.projectLatlngs,moveend:this._updatePath},this)},addTo:function(map){map.addLayer(this);for(var i=0;i<this.icons.length;i++)this._map.addLayer(this.icons[i]);return this},onRemove:function(map){map._pathRoot.removeChild(this._container);for(var i=0;i<this.icons.length;i++)this._map.removeLayer(this.icons[i]);delete this.icons;this.fire("remove");this._map=null;if(L.Browser.vml){this._container=null;this._stroke=null;this._fill=null}map.off({viewreset:this.projectLatlngs,moveend:this._updatePath},this)}});L.markerline=function(latlngs,options){return new L.Markerline(latlngs,options)};L.Draw.Markerline=L.Draw.Polyline.extend({options:{allowIntersection:true,repeatMode:false,drawError:{color:"#b00b00",timeout:2500},icon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon"}),markerIcon:L.icon({iconUrl:"/js/tool/zmap/images/marker-arrow.png",iconSize:[20,28],iconAnchor:[10,14]}),markerPos:.5,guidelineDistance:20,maxGuideLineLength:4e3,shapeOptions:{stroke:true,color:"#f06eaa",weight:4,opacity:.5,fill:false,clickable:true},metric:true,showLength:true,zIndexOffset:2e3},addVertex:function(latlng){var markersLength=this._markers.length;if(markersLength>0){var latlng0=this._markers[markersLength-1].getLatLng();var angle=L.Util.lineAngle(latlng0,latlng);var arrowLatlng=L.Util.linePoint(latlng0,latlng,this.options.markerPos);var arrow=L.angleMarker(arrowLatlng,{icon:this.options.markerIcon,iconAngle:angle});this._markerGroup.addLayer(arrow);if(!this._icons)this._icons=[];this._icons.push(arrow)}if(markersLength>0&&!this.options.allowIntersection&&this._poly.newLatLngIntersects(latlng)){this._showErrorTooltip();return}else if(this._errorShown){this._hideErrorTooltip()}this._markers.push(this._createMarker(latlng));this._poly.addLatLng(latlng);if(this._poly.getLatLngs().length===2){this._map.addLayer(this._poly)}this._vertexChanged(latlng,true)},_fireCreatedEvent:function(){this.type="markerline";var markerline=L.markerline(this._poly.getLatLngs(),this.options);L.Draw.Feature.prototype._fireCreatedEvent.call(this,markerline)}});L.Draw.markerline=function(map,options){return new L.Draw.Markerline(map,options)};L.BusinessOverlay=L.Class.extend({includes:L.Mixin.Events,options:{opacity:1},initialize:function(url,options){this._url=url;L.setOptions(this,options)},onAdd:function(map){this._map=map;this._bounds=this._map.getBounds();if(!this._image){this._initImage()}map._panes.overlayPane.appendChild(this._image);map.on("viewreset",this._reset,this);if(map.options.zoomAnimation&&L.Browser.any3d){map.on("zoomanim",this._animateZoom,this)}this._reset()},onRemove:function(map){map.getPanes().overlayPane.removeChild(this._image);map.off("viewreset",this._reset,this);if(map.options.zoomAnimation){map.off("zoomanim",this._animateZoom,this)}},addTo:function(map){map.addLayer(this);return this},setOpacity:function(opacity){this.options.opacity=opacity;this._updateOpacity();return this},bringToFront:function(){if(this._image){this._map._panes.overlayPane.appendChild(this._image)}return this},bringToBack:function(){var pane=this._map._panes.overlayPane;if(this._image){pane.insertBefore(this._image,pane.firstChild)}return this},setUrl:function(url){this._url=url;this._image.src=this._url},setUrlAutoFit:function(url){if(this._oldImage&&this._image!=this._oldImage){this._map._panes.overlayPane.removeChild(this._oldImage)}this._oldImage=this._image;this._url=url;this._bounds=this._map.getBounds();var newImage=L.DomUtil.create("img","leaflet-image-layer");if(this._map.options.zoomAnimation&&L.Browser.any3d){L.DomUtil.addClass(newImage,"leaflet-zoom-animated")}else{L.DomUtil.addClass(newImage,"leaflet-zoom-hide")}L.extend(newImage,{galleryimg:"no",onselectstart:L.Util.falseFn,onmousemove:L.Util.falseFn,onload:L.bind(this._onImageLoad,this),src:url});this._map._panes.overlayPane.appendChild(newImage);var topLeft=this._map.latLngToLayerPoint(this._bounds.getNorthWest());var size=this._map.latLngToLayerPoint(this._bounds.getSouthEast())._subtract(topLeft);L.DomUtil.setPosition(newImage,topLeft);newImage.style.width=size.x+"px";newImage.style.height=size.y+"px";newImage.style.visibility="hidden";this._image=newImage},getAttribution:function(){return this.options.attribution},_initImage:function(){this._image=L.DomUtil.create("img","leaflet-image-layer");this._oldImage=this._image;if(this._map.options.zoomAnimation&&L.Browser.any3d){L.DomUtil.addClass(this._image,"leaflet-zoom-animated")}else{L.DomUtil.addClass(this._image,"leaflet-zoom-hide")}this._updateOpacity();L.extend(this._image,{galleryimg:"no",onselectstart:L.Util.falseFn,onmousemove:L.Util.falseFn,onload:L.bind(this._onImageLoad,this),src:this._url})},_animateZoom:function(e){var map=this._map,image=this._image,scale=map.getZoomScale(e.zoom),nw=this._bounds.getNorthWest(),se=this._bounds.getSouthEast(),topLeft=map._latLngToNewLayerPoint(nw,e.zoom,e.center),size=map._latLngToNewLayerPoint(se,e.zoom,e.center)._subtract(topLeft),origin=topLeft._add(size._multiplyBy(1/2*(1-1/scale)));image.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(origin)+" scale("+scale+") "},_reset:function(){var image=this._image,topLeft=this._map.latLngToLayerPoint(this._bounds.getNorthWest()),size=this._map.latLngToLayerPoint(this._bounds.getSouthEast())._subtract(topLeft);L.DomUtil.setPosition(image,topLeft);image.style.width=size.x+"px";image.style.height=size.y+"px"},_onImageLoad:function(){this.fire("load");if(this._oldImage&&this._image!=this._oldImage){this._map._panes.overlayPane.removeChild(this._oldImage);this._oldImage=null;this._image.style.visibility="visible"}},_updateOpacity:function(){L.DomUtil.setOpacity(this._image,this.options.opacity)}});L.businessOverlay=function(url,bounds,options){return new L.BusinessOverlay(url,bounds,options)};L.Polyline.Measure=L.Draw.Polyline.extend({addHooks:function(){L.Draw.Polyline.prototype.addHooks.call(this);if(this._map){this._markerGroup=new L.LayerGroup;this._map.addLayer(this._markerGroup);this._markers=[];this._startShape()}},removeHooks:function(){L.Draw.Polyline.prototype.removeHooks.call(this);this._clearHideErrorTimeout();this._map.off("mousemove",this._onMouseMove);this._clearGuides();this._container.style.cursor="";this._removeShape()},start:function(){this._removeShape();this._startShape()},stop:function(){this._removeShape()},_startShape:function(){this._drawing=true;this._poly=new L.Polyline([],this.options.shapeOptions);this._container.style.cursor="crosshair";this._updateTooltip();this._map.on("mousemove",this._onMouseMove,this)},_finishShape:function(){this._drawing=false;this._cleanUpShape();this._clearGuides();this._updateTooltip();this._map.off("mousemove",this._onMouseMove,this);this._container.style.cursor="";this._map.removeLayer(this._mouseMarker)},_removeShape:function(){if(!this._poly)return;this._map.removeLayer(this._poly);delete this._poly;this._markers.splice(0);this._markerGroup.clearLayers()},_updateGuide:function(newPos){var markerCount=this._markers.length;if(markerCount>0){newPos=newPos||this._map.latLngToLayerPoint(this._currentLatLng);this._clearGuides();this._drawGuide(this._map.latLngToLayerPoint(this._markers[markerCount-1].getLatLng()),newPos);if(!this._drawing){var e=this._markers.length;this._tooltip.updatePosition(this._markers[e-1].getLatLng())}}},_getTooltipText:function(){var labelText=L.Draw.Polyline.prototype._getTooltipText.call(this);if(!this._drawing){labelText.text=""}return labelText}});L.Draw.ArrowLine=L.Draw.Polyline.extend({addVertex:function(latlng){var markersLength=this._markers.length;if(markersLength>0&&!this.options.allowIntersection&&this._poly.newLatLngIntersects(latlng)){this._showErrorTooltip();return}else if(this._errorShown){this._hideErrorTooltip()}this._markers.push(this._createMarker(latlng));this._poly.addLatLng(latlng);if(this._poly.getLatLngs().length===2){this._map.addLayer(this._poly)}this._vertexChanged(latlng,true);if(this._markers.length>=2)this._finishShape()},_fireCreatedEvent:function(){var latlngs=this._poly.getLatLngs();if(latlngs.length!=2)return;var s=latlngs[0];var e=latlngs[1];var pa=this._map.latLngToLayerPoint(e);var pb=this._map.latLngToLayerPoint(s);var pc=L.Util.collinearPoint(pa,pb,10);var pns1=L.Util.verticalPoints(pa,pb,pc,3);var pns2=L.Util.verticalPoints(pa,pb,pc,7);var platlngs=[];platlngs.push(this._map.layerPointToLatLng(pa));platlngs.push(this._map.layerPointToLatLng(pns2[0]));platlngs.push(this._map.layerPointToLatLng(pns1[0]));platlngs.push(this._map.layerPointToLatLng(pb));platlngs.push(this._map.layerPointToLatLng(pns1[1]));platlngs.push(this._map.layerPointToLatLng(pns2[1]));platlngs.push(this._map.layerPointToLatLng(pa));var poly=new this.Poly(platlngs,this.options.shapeOptions);L.Draw.Feature.prototype._fireCreatedEvent.call(this,poly)}});L.Draw.arrowLine=function(map,options){return new L.Draw.ArrowLine(map,options)};L.BoxZoom=L.Handler.extend({addHooks:function(){this._map.on("mousedown",this._setStateOn,this);this._map.on("boxzoomend",this._setStateOff,this)},removeHooks:function(){this._map.off("mousedown",this._setStateOn,this)},_setStateOn:function(event){this._map.dragging.disable();this._map.boxZoom.addHooks();this._map.boxZoom._onMouseDown.call(this._map.boxZoom,{clientX:event.originalEvent.clientX,clientY:event.originalEvent.clientY,which:1,shiftKey:true})},_setStateOff:function(){this.active=false;this._map.dragging.enable();this._map.boxZoom.removeHooks()}});L.boxzoom=function(map){return new L.BoxZoom(map)};